default: help

set shell := ["bash", "-euo", "pipefail", "-c"]

uv := env_var_or_default("UV", "uv")

help:
    @just --list

setup:
    if command -v git >/dev/null 2>&1; then
        if [ ! -d .git ]; then
            git init
        fi

        if ! git rev-parse --verify HEAD >/dev/null 2>&1; then
            git commit --allow-empty -m "Initial commit"
        fi

        if git rev-parse --verify dev >/dev/null 2>&1; then
            git switch dev
        else
            git switch -c dev
        fi

        git add -A
        if ! git diff --cached --quiet; then
            git commit -m "chore: scaffold project"
        fi
    else
        echo "git not found; skipping repository initialization."
    fi

    uv sync --all-groups

    if command -v git >/dev/null 2>&1; then
        git add -A
        if ! git diff --cached --quiet; then
            git commit -m "chore: sync dependencies"
        fi

        uv run pre-commit install
    fi

    echo "Setup complete."

sync:
    uv sync --all-groups
    if command -v git >/dev/null 2>&1; then
        uv run pre-commit install
    else
        echo "git not found; skipping pre-commit installation."
    fi
    echo "Environment sync complete."

update:
    uv lock --upgrade --refresh
    uv sync --all-groups
    uv run pre-commit autoupdate
    if command -v git >/dev/null 2>&1 && [ -d .git ]; then
        for file in pyproject.toml uv.lock .pre-commit-config.yaml; do
            if [ -e "$file" ]; then
                git add "$file"
            fi
        done
        if ! git diff --cached --quiet; then
            git commit -m "chore: refresh tooling"
        else
            echo "No update-related changes to commit."
        fi
        uv run pre-commit install
    else
        echo "git not found; skipping commit and hook installation."
    fi
    echo "Tooling update complete."

format:
    uv run ruff format ./src ./tests

lint:
    uv run ruff check --fix ./src ./tests
    uv run mypy ./src ./tests
    uv run bandit -c pyproject.toml -r ./src ./tests

check: format lint
    @echo "Formatting and linting complete."

test:
    uv run pytest --cov=src --cov-report=term-missing -n auto ./tests

build:
    uv build

docs:
    uv run sphinx-build -b html docs docs/_build/html

docs-serve:
    uv run sphinx-autobuild docs docs/_build/html

clean:
    find ./ -type f -name "*.py[co]" -delete
    find ./ -type d -name "__pycache__" -prune -exec rm -rf {} +
    rm -rf dist htmlcov .coverage .venv .uv .cache docs/_build
    echo "Workspace cleaned."
